// REQUIRES: clang-driver
// REQUIRES: x86-registered-target
// REQUIRES: amdgpu-registered-target

// Check invalid -fuse-cuid= option.

// RUN: not %clang -### -x hip \
// RUN:   -target x86_64-unknown-linux-gnu \
// RUN:   --offload-arch=gfx900 \
// RUN:   --offload-arch=gfx906 \
// RUN:   -c -nogpulib -fuse-cuid=invalid \
// RUN:   %S/Inputs/hip_multiple_inputs/a.cu \
// RUN:   %S/Inputs/hip_multiple_inputs/b.hip \
// RUN: 2>&1 | FileCheck -check-prefixes=INVALID %s

// INVALID: invalid value 'invalid' in '-fuse-cuid=invalid'

// Check random CUID generator.

// RUN: %clang -### -x hip \
// RUN:   -target x86_64-unknown-linux-gnu \
// RUN:   --offload-arch=gfx900 \
// RUN:   --offload-arch=gfx906 \
// RUN:   -c -nogpulib -fuse-cuid=random \
// RUN:   %S/Inputs/hip_multiple_inputs/a.cu \
// RUN:   %S/Inputs/hip_multiple_inputs/b.hip \
// RUN: 2>&1 | FileCheck -check-prefixes=COMMON,HEX %s

// Check fixed CUID.

// RUN: %clang -### -x hip \
// RUN:   -target x86_64-unknown-linux-gnu \
// RUN:   --offload-arch=gfx900 \
// RUN:   --offload-arch=gfx906 \
// RUN:   -c -nogpulib -cuid=abcd \
// RUN:   %S/Inputs/hip_multiple_inputs/a.cu \
// RUN:   %S/Inputs/hip_multiple_inputs/b.hip \
// RUN: 2>&1 | FileCheck -check-prefixes=COMMON,FIXED %s

// Check fixed CUID override -fuse-cuid.

// RUN: %clang -### -x hip \
// RUN:   -target x86_64-unknown-linux-gnu \
// RUN:   --offload-arch=gfx900 \
// RUN:   --offload-arch=gfx906 \
// RUN:   -c -nogpulib -fuse-cuid=random -cuid=abcd \
// RUN:   %S/Inputs/hip_multiple_inputs/a.cu \
// RUN:   %S/Inputs/hip_multiple_inputs/b.hip \
// RUN: 2>&1 | FileCheck -check-prefixes=COMMON,FIXED %s

// Check hash CUID generator.

// RUN: %clang -### -x hip \
// RUN:   -target x86_64-unknown-linux-gnu \
// RUN:   --offload-arch=gfx900 \
// RUN:   --offload-arch=gfx906 \
// RUN:   -c -nogpulib -fuse-cuid=hash \
// RUN:   %S/Inputs/hip_multiple_inputs/a.cu \
// RUN:   %S/Inputs/hip_multiple_inputs/b.hip \
// RUN: 2>&1 | FileCheck -check-prefixes=COMMON,HEX %s

// COMMON: "{{.*}}clang{{.*}}" "-cc1" "-triple" "amdgcn-amd-amdhsa"
// COMMON-SAME: "-target-cpu" "gfx900"
// HEX-SAME: "-cuid=[[CUID:[0-9a-f]+]]"
// FIXED-SAME: "-cuid=[[CUID:abcd]]"
// COMMON-SAME: "{{.*}}a.cu"

// COMMON: "{{.*}}clang{{.*}}" "-cc1" "-triple" "amdgcn-amd-amdhsa"
// COMMON-SAME: "-target-cpu" "gfx906"
// COMMON-SAME: "-cuid=[[CUID]]"
// COMMON-SAME: "{{.*}}a.cu"

// COMMON: "{{.*}}clang{{.*}}" "-cc1" "-triple" "x86_64-unknown-linux-gnu"
// COMMON-SAME: "-cuid=[[CUID]]"
// COMMON-SAME: "{{.*}}a.cu"

// COMMON: "{{.*}}clang{{.*}}" "-cc1" "-triple" "amdgcn-amd-amdhsa"
// COMMON-SAME: "-target-cpu" "gfx900"
// HEX-NOT: "-cuid=[[CUID]]"
// HEX-SAME: "-cuid=[[CUID2:[0-9a-f]+]]"
// FIXED-SAME: "-cuid=[[CUID2:abcd]]"
// COMMON-SAME: "{{.*}}b.hip"

// COMMON: "{{.*}}clang{{.*}}" "-cc1" "-triple" "amdgcn-amd-amdhsa"
// COMMON-SAME: "-target-cpu" "gfx906"
// HEX-NOT: "-cuid=[[CUID]]"
// COMMON-SAME: "-cuid=[[CUID2]]"
// COMMON-SAME: "{{.*}}b.hip"

// COMMON: "{{.*}}clang{{.*}}" "-cc1" "-triple" "x86_64-unknown-linux-gnu"
// HEX-NOT: "-cuid=[[CUID]]"
// COMMON-SAME: "-cuid=[[CUID2]]"
// COMMON-SAME: "{{.*}}b.hip"

// Check CUID generated by hash.
// The same CUID is generated for the same file with the same options.

// RUN: rm -rf %t.out

// RUN: %clang -### -x hip -target x86_64-unknown-linux-gnu \
// RUN:   --offload-arch=gfx906 -c -nogpulib -fuse-cuid=hash \
// RUN:   %S/Inputs/hip_multiple_inputs/a.cu >%t.out 2>&1

// RUN: %clang -### -x hip -target x86_64-unknown-linux-gnu \
// RUN:   --offload-arch=gfx906 -c -nogpulib -fuse-cuid=hash \
// RUN:   %S/Inputs/hip_multiple_inputs/a.cu >>%t.out 2>&1

// RUN: FileCheck %s -check-prefixes=HASH -input-file %t.out

// HASH: "{{.*}}clang{{.*}}" {{.*}} "-target-cpu" "gfx906" {{.*}}"-cuid=[[CUID:[0-9a-f]+]]"
// HASH: "{{.*}}clang{{.*}}" {{.*}} "-target-cpu" "gfx906" {{.*}}"-cuid=[[CUID]]"


// Check CUID generated by hash.
// Different CUID's are generated for the same file with different options.

// RUN: rm -rf %t.out

// RUN: %clang -### -x hip -target x86_64-unknown-linux-gnu -DX=1 \
// RUN:   --offload-arch=gfx906 -c -nogpulib -fuse-cuid=hash \
// RUN:   %S/Inputs/hip_multiple_inputs/a.cu >%t.out 2>&1

// RUN: %clang -### -x hip -target x86_64-unknown-linux-gnu -DX=2 \
// RUN:   --offload-arch=gfx906 -c -nogpulib -fuse-cuid=hash \
// RUN:   %S/Inputs/../Inputs/hip_multiple_inputs/a.cu >>%t.out 2>&1

// RUN: FileCheck %s -check-prefixes=HASH2 -input-file %t.out

// HASH2: "{{.*}}clang{{.*}}" {{.*}} "-target-cpu" "gfx906" {{.*}}"-cuid=[[CUID:[0-9a-f]+]]"
// HASH2-NOT: "{{.*}}clang{{.*}}" {{.*}} "-target-cpu" "gfx906" {{.*}}"-cuid=[[CUID]]"
